---
import { Image, Picture } from "astro:assets";
import Layout from "../layouts/Layout.astro";
import fetchApi from "../lib/strapi";

const API_URL = "http://localhost:1337/api/books";

const API_ENDPOINT_CAT = "categories";
const API_ENDPOINT_AUTHORS = "authors";
const queryParametersCat = { populate: "books.cover" };
const queryParametersAuthors = { populate: "books.cover" };

// Fetch category and author data
const cats = await fetchApi({
  endpoint: API_ENDPOINT_CAT,
  query: queryParametersCat,
  wrappedByKey: "data",
});
const authors = await fetchApi({
  endpoint: API_ENDPOINT_AUTHORS,
  query: queryParametersAuthors,
  wrappedByKey: "data",
});

// Default category and books initialization
let selectedCategory = cats[0];
let books = selectedCategory.books;
---

<Layout>
  <section>
    <h2>Books</h2>

    <!-- Categories Section -->
    <button class="categories__catBtn" id="allCategoriesBtn">All</button>
    
    <h3>Categories</h3>
    <div class="categories">
      {
        cats.map((cat) => (
          <button class="categories__catBtn" data-category-id={cat.documentId}>
            {cat.name}
          </button>
        ))
      }
    </div>

    <!-- Authors Section -->
    <h3>Authors</h3>
    <div class="authors">
      {
        authors.map((author) => (
          <button class="authors__authorBtn" data-author-id={author.documentId}>
            {author.name}
          </button>
        ))
      }
    </div>

    <div class="card-container" id="card-container">
      <!-- Books will be inserted here by JS -->
    </div>
  </section>

  <script type="module" client:load>
    const API_URL_BOOKS = "http://localhost:1337/api/books/?populate=cover";
    const API_URL_CAT = "http://localhost:1337/api/categories/?populate=books.cover";
    const API_URL_AUTHORS = "http://localhost:1337/api/authors/?populate=books.cover";

    const cardContainer = document.getElementById("card-container");

    const urlParams = new URLSearchParams(window.location.search);
    const authorIdFromQuery = urlParams.get("author"); // Get the author ID from the URL query

    const responseAll = await fetch(API_URL_BOOKS);
    const dataAll = await responseAll.json();
    const allBooks = dataAll.data || [];
    renderBooks(allBooks);

    function renderBooks(books) {
      cardContainer.innerHTML = "";
      books.forEach((book) => {
        const thumbnail_url_Books = book.cover?.url || "/placeholder-image.jpg";

        const card = document.createElement("div");
        card.classList.add("card");
        card.innerHTML = `
      <div class="card__image">
          <Image
    src="http://localhost:1337${thumbnail_url_Books}"
    alt="${book.title || "No title"}"
    width="300"
    height="400"
    widths={[250, 350, 500, 750]}
    format="avif"
    sizes="(min-width: 2960px) calc(12.5vw - 118px), (min-width: 2600px) calc(5vw + 121px), (min-width: 2240px) calc(5.29vw + 131px), (min-width: 1900px) calc(5vw + 157px), (min-width: 1540px) calc(4.71vw + 180px), (min-width: 1160px) calc(3.33vw + 217px), (min-width: 1120px) calc(325vw - 3455px), (min-width: 760px) calc(3.53vw + 229px), (min-width: 540px) calc(42vw - 43px), calc(8.18vw + 225px)"
  />
      </div>
      <div class="card_txt">
        <h3>${book.title || "No title"}</h3>
      </div>
      <div class="card__content">
        <a href="/details/${book.documentId}">
          <button>Read more</button>
        </a>
      </div>

    `;
        cardContainer.appendChild(card);
      });
    }

    const categoryButtons = document.querySelectorAll(".categories__catBtn");
    const authorButtons = document.querySelectorAll(".authors__authorBtn");

    function setActiveButton(clickedButton) {
      categoryButtons.forEach((button) => button.classList.remove("active"));
      authorButtons.forEach((button) => button.classList.remove("active"));

      clickedButton?.classList.add("active");
    }

    // Filter books by authorId if present in the URL
    if (authorIdFromQuery) {
      const authorButton = document.querySelector(
        `.authors__authorBtn[data-author-id="${authorIdFromQuery}"]`
      );

      // Set the active state and fetch the corresponding books
      if (authorButton) {
        setActiveButton(authorButton);
        const authorId = authorButton.getAttribute("data-author-id");
        fetchAndRenderBooksByAuthor(authorId);
      }
    }

    // Handle category and author buttons
    categoryButtons.forEach((button) => {
      button.addEventListener("click", async (event) => {
        const categoryId = event.target.getAttribute("data-category-id");
        setActiveButton(event.target);

        if (categoryId) {
          const response = await fetch(
            `http://localhost:1337/api/categories/${categoryId}?populate=books.cover`
          );
          const data = await response.json();
          renderBooks(data.data.books || []);
        } else {
          renderBooks(allBooks);
        }
      });
    });

    authorButtons.forEach((button) => {
      button.addEventListener("click", async (event) => {
        const authorId = event.target.getAttribute("data-author-id");
        setActiveButton(event.target);

        if (authorId) {
          fetchAndRenderBooksByAuthor(authorId);
        } else {
          renderBooks(allBooks);
        }
      });
    });

    async function fetchAndRenderBooksByAuthor(authorId) {
      try {
        const response = await fetch(
          `http://localhost:1337/api/authors/${authorId}?populate=books.cover`
        );
        const data = await response.json();
        renderBooks(data.data.books || []);
      } catch (error) {
        console.error("Error fetching author books:", error);
        renderBooks([]);
      }
    }
</script>
</Layout>

<style>
  .categories, .authors {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .categories__catBtn.active, .authors__authorBtn.active {
  background-color: var(--c-darkgreen);
  color: white;
  border: 2px solid var(--c-light);
}


  .categories__catBtn, .authors__authorBtn {
    padding: 1rem 2rem;
    background-color: var(--c-green);
    cursor: pointer;
    transition: background-color 0.2s;
    margin-bottom: 10px;
  }

  .categories__catBtn:hover, .authors__authorBtn:hover {
    background-color: var(--c-darkgreen);
    color: white;
  }

  .card-container {
    margin-top: 20px;
  }

  .card {
    padding: 10px;
    border: 1px solid #ddd;
    margin-bottom: 10px;
  }
</style>
